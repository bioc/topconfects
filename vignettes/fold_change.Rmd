---
title: "Confident fold change"
author: "Paul Harrison"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Confident fold change}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style>
.contents h2 { margin-top: 2em }
</style>

This document shows typical Topconfects usage.

The first step is to load a dataset. Here, we're looking at RNA-seq data that investigates the response of *Arabodopsis thaliana* to a bacterial pathogen. Besides the experimental and control conditions, there is also a batch effect. This dataset is also examined in section 4.2 of the `edgeR` user manual, and I've followed the initial filtering steps in the `edgeR` manual.

```{r message=FALSE, warning=FALSE}
library(topconfects)

library(NBPSeq)
library(edgeR)
library(limma)
library(dplyr)
library(ggplot2)

data(arab)

Treat <- factor(substring(colnames(arab),1,4)) %>% relevel(ref="mock")
Time <- factor(substring(colnames(arab),5,5))
y <- DGEList(arab)

# Keep genes with at least 3 samples having an RPM of more than 2
keep <- rowSums(cpm(y)>2) >= 3
y <- y[keep,,keep.lib.sizes=FALSE]
y <- calcNormFactors(y)
```


## limma analysis

### Standard limma analysis steps

```{r}
design <- model.matrix(~Time+Treat)
design[,]

fit <-
    voom(y, design) %>%
    lmFit(design)

cfit <- 
    contrasts.fit(fit, coefficients=4) %>% 
    eBayes()

cfit$df.prior
```

### Apply topconfects

Find largest fold changes that we can be confident of at FDR 0.05.

```{r}
confects <- limma_confects(cfit, fdr=0.05)
```

<br/>

```{r}
head(confects)
```


### Looking at the result

Here the usual `logFC` values estimated by `limma` are shown as dots, with lines to the `signed_confect` value.

```{r fig.height=7}
head(confects, 50) %>% 
mutate(name=factor(name,rev(name))) %>%
ggplot(aes(y=name, x=logFC)) +
    geom_vline(xintercept=0) +
    geom_segment(aes(yend=name, x=signed_confect, xend=logFC)) +
    geom_point(aes(size=AveExpr)) + scale_size(limits=c(0,15),range=c(0,5))
```

If we had gone by the default `topTable` order, there is greater focus on highly expressed genes. Some lower expressed genes are demoted, even though there is perfectly adequate evidence of a large fold change.

```{r, fig.height=7}
top <- topTable(cfit, n=Inf)
top$name <- rownames(top) %>% factor(.,rev(.))
top$signed_confect <- confects$signed_confect[ match(top$name, confects$name) ]
ggplot(head(top, 50), aes(y=name, x=logFC)) +
    geom_vline(xintercept=0) +
    geom_segment(aes(yend=name, x=signed_confect, xend=logFC)) +
    geom_point(aes(size=AveExpr)) + scale_size(limits=c(0,15),range=c(0,5))
```

An MD-plot highlighting the positions of the top 20 genes in both rankings illustrates this.

```{r}
plotMD(cfit, legend="bottomleft", status=paste0(
    ifelse(rownames(cfit) %in% top$name[1:20], "topTable ",""),
    ifelse(rownames(cfit) %in% confects$name[1:20], "confects ","")))
```

Note the `confects` results above are the same as would be obtained using `limma::treat(cfit, lfc=2.15)`.

```{r}
confects$confect[20]
```

Genes that are not even different from zero effect size at the chosen FDR are given a `confect` of NA. We would have found 2184 genes using a traditional `limma::topTable` analysis with FDR=0.05.

```{r}
table(is.na(confects$confect))
```

## edgeR analysis

An analysis in edgeR produces similar results.

### Standard edgeR analysis

```{r}
y <- estimateDisp(y, design, robust=TRUE)
efit <- glmQLFit(y, design, robust=TRUE)
```

### Apply topconfects

```{r}
econfects <- edger_confects(efit, coef=4, fdr=0.05)
```

```{r}
head(econfects)
```


### Looking at the result

```{r fig.height=7}
head(econfects, 50) %>% 
mutate(name=factor(name,rev(name))) %>%
ggplot(aes(y=name, x=logFC)) +
    geom_vline(xintercept=0) +
    geom_segment(aes(yend=name, x=signed_confect, xend=logFC)) +
    geom_point(aes(size=logCPM)) + scale_size(limits=c(0,15),range=c(0,5))
```

```{r}
etop <-
    glmQLFTest(efit, coef=4) %>%
    topTags(n=Inf)

plotMD(efit, legend="bottomleft", status=paste(
    ifelse(rownames(cfit) %in% econfects$name[1:20], "confects ", ""),
    ifelse(rownames(cfit) %in% rownames(etop)[1:20], "topTags ","")))
```

---

```{r}
sessionInfo()
```


